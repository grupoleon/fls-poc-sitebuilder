# nixpacks.toml
# PHP application with index.php served by nginx + php-fpm (provided by Kinsta)
providers = ["php"]

[phases.setup]
# Install required CLI tools for deployment scripts
nixPkgs = ["bash", "git", "jq", "curl", "openssl", "coreutils", "nodejs"]
cmds = [
  "echo '=== Setting up application directories ==='",
  # Create all required directories with subdirectories
  "mkdir -p /app/config /app/logs/api /app/logs/deployment /app/tmp",
  # Set ownership to nobody:nogroup for writable directories
  "chown -R nobody:nogroup /app/config /app/logs /app/tmp",
  # Set proper permissions (rwx for owner, rx for group/others on dirs, rw for files)
  "chmod -R 755 /app/config /app/logs /app/tmp",
  # Verify setup
  "echo '=== Directory permissions set ==='",
  "ls -ld /app/config /app/logs /app/tmp || true",
  "ls -la /app/logs || true"
]

[start]
# Kinsta provides nginx + php-fpm, but nixpacks needs a start command
# Use php-fpm as the process that keeps the container running
cmd = "php-fpm -F"

# Nginx + php-fpm handles web serving (provided by Kinsta platform)
# index.php serves as the application entry point
